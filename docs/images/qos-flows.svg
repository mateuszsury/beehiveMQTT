<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 780 520" width="780" height="520">
  <defs>
    <style>
      .title { font-family: 'Segoe UI', Arial, sans-serif; font-size: 16px; font-weight: 700; fill: #1A1A1A; }
      .subtitle { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; font-weight: 600; fill: #333; }
      .actor { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; font-weight: 600; fill: #fff; }
      .msg { font-family: 'Consolas', 'Courier New', monospace; font-size: 10px; fill: #1A1A1A; }
      .note { font-family: 'Segoe UI', Arial, sans-serif; font-size: 9px; fill: #666; font-style: italic; }
    </style>
    <marker id="arrowR" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#333"/></marker>
    <marker id="arrowL" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M8,0 L0,3 L8,6" fill="#333"/></marker>
  </defs>

  <text x="390" y="25" text-anchor="middle" class="title">MQTT QoS Message Delivery Flows</text>

  <!-- QoS 0 -->
  <g transform="translate(10, 45)">
    <text x="120" y="0" text-anchor="middle" class="subtitle">QoS 0: At Most Once</text>
    <!-- Actors -->
    <rect x="20" y="10" width="80" height="24" rx="4" fill="#2196F3"/>
    <text x="60" y="26" text-anchor="middle" class="actor">Publisher</text>
    <rect x="150" y="10" width="80" height="24" rx="4" fill="#F5A623"/>
    <text x="190" y="26" text-anchor="middle" class="actor">Broker</text>
    <!-- Lifelines -->
    <line x1="60" y1="34" x2="60" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <line x1="190" y1="34" x2="190" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <!-- PUBLISH -->
    <line x1="60" y1="55" x2="190" y2="55" stroke="#333" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="125" y="50" text-anchor="middle" class="msg">PUBLISH</text>
    <!-- Note -->
    <text x="125" y="90" text-anchor="middle" class="note">Fire and forget</text>
    <text x="125" y="102" text-anchor="middle" class="note">No acknowledgment</text>
    <rect x="5" y="-10" width="230" height="140" rx="6" fill="none" stroke="#E0E0E0" stroke-width="1"/>
  </g>

  <!-- QoS 1 -->
  <g transform="translate(265, 45)">
    <text x="120" y="0" text-anchor="middle" class="subtitle">QoS 1: At Least Once</text>
    <!-- Actors -->
    <rect x="20" y="10" width="80" height="24" rx="4" fill="#2196F3"/>
    <text x="60" y="26" text-anchor="middle" class="actor">Publisher</text>
    <rect x="150" y="10" width="80" height="24" rx="4" fill="#F5A623"/>
    <text x="190" y="26" text-anchor="middle" class="actor">Broker</text>
    <!-- Lifelines -->
    <line x1="60" y1="34" x2="60" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <line x1="190" y1="34" x2="190" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <!-- PUBLISH -->
    <line x1="60" y1="55" x2="190" y2="55" stroke="#333" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="125" y="50" text-anchor="middle" class="msg">PUBLISH (QoS 1)</text>
    <!-- PUBACK -->
    <line x1="190" y1="80" x2="60" y2="80" stroke="#4CAF50" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="125" y="75" text-anchor="middle" class="msg" fill="#4CAF50">PUBACK</text>
    <!-- Note -->
    <text x="125" y="110" text-anchor="middle" class="note">Retry on timeout (DUP=1)</text>
    <rect x="5" y="-10" width="230" height="140" rx="6" fill="none" stroke="#E0E0E0" stroke-width="1"/>
  </g>

  <!-- QoS 2 -->
  <g transform="translate(520, 45)">
    <text x="120" y="0" text-anchor="middle" class="subtitle">QoS 2: Exactly Once</text>
    <!-- Actors -->
    <rect x="20" y="10" width="80" height="24" rx="4" fill="#2196F3"/>
    <text x="60" y="26" text-anchor="middle" class="actor">Publisher</text>
    <rect x="150" y="10" width="80" height="24" rx="4" fill="#F5A623"/>
    <text x="190" y="26" text-anchor="middle" class="actor">Broker</text>
    <!-- Lifelines -->
    <line x1="60" y1="34" x2="60" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <line x1="190" y1="34" x2="190" y2="120" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <!-- PUBLISH -->
    <line x1="60" y1="50" x2="190" y2="50" stroke="#333" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="125" y="46" text-anchor="middle" class="msg">PUBLISH (QoS 2)</text>
    <!-- PUBREC -->
    <line x1="190" y1="68" x2="60" y2="68" stroke="#9C27B0" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="125" y="64" text-anchor="middle" class="msg" fill="#9C27B0">PUBREC</text>
    <!-- PUBREL -->
    <line x1="60" y1="86" x2="190" y2="86" stroke="#FF5722" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="125" y="82" text-anchor="middle" class="msg" fill="#FF5722">PUBREL</text>
    <!-- PUBCOMP -->
    <line x1="190" y1="104" x2="60" y2="104" stroke="#4CAF50" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="125" y="100" text-anchor="middle" class="msg" fill="#4CAF50">PUBCOMP</text>
    <rect x="5" y="-10" width="230" height="140" rx="6" fill="none" stroke="#E0E0E0" stroke-width="1"/>
  </g>

  <!-- Full QoS 2 flow (detailed) -->
  <g transform="translate(50, 210)">
    <text x="340" y="0" text-anchor="middle" class="subtitle">QoS 2 Full Flow: Publisher to Subscriber via Broker</text>

    <!-- Actors -->
    <rect x="20" y="15" width="100" height="24" rx="4" fill="#2196F3"/>
    <text x="70" y="31" text-anchor="middle" class="actor">Publisher</text>
    <rect x="280" y="15" width="100" height="24" rx="4" fill="#F5A623"/>
    <text x="330" y="31" text-anchor="middle" class="actor">Broker</text>
    <rect x="540" y="15" width="100" height="24" rx="4" fill="#4CAF50"/>
    <text x="590" y="31" text-anchor="middle" class="actor">Subscriber</text>

    <!-- Lifelines -->
    <line x1="70" y1="39" x2="70" y2="290" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <line x1="330" y1="39" x2="330" y2="290" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>
    <line x1="590" y1="39" x2="590" y2="290" stroke="#ccc" stroke-width="1" stroke-dasharray="4"/>

    <!-- Phase 1: Publisher -> Broker -->
    <rect x="0" y="50" width="400" height="115" rx="4" fill="#F5F5F5" stroke="#E0E0E0"/>
    <text x="200" y="64" text-anchor="middle" class="note">Inbound (Publisher to Broker)</text>

    <line x1="70" y1="78" x2="330" y2="78" stroke="#333" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="200" y="74" text-anchor="middle" class="msg">PUBLISH (QoS 2, ID=1)</text>

    <text x="340" y="100" class="note">Store message</text>

    <line x1="330" y1="110" x2="70" y2="110" stroke="#9C27B0" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="200" y="106" text-anchor="middle" class="msg" fill="#9C27B0">PUBREC (ID=1)</text>

    <line x1="70" y1="130" x2="330" y2="130" stroke="#FF5722" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="200" y="126" text-anchor="middle" class="msg" fill="#FF5722">PUBREL (ID=1)</text>

    <line x1="330" y1="150" x2="70" y2="150" stroke="#4CAF50" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="200" y="146" text-anchor="middle" class="msg" fill="#4CAF50">PUBCOMP (ID=1)</text>

    <!-- Phase 2: Broker -> Subscriber -->
    <rect x="260" y="172" width="400" height="115" rx="4" fill="#F5F5F5" stroke="#E0E0E0"/>
    <text x="460" y="186" text-anchor="middle" class="note">Outbound (Broker to Subscriber)</text>

    <line x1="330" y1="200" x2="590" y2="200" stroke="#333" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="460" y="196" text-anchor="middle" class="msg">PUBLISH (QoS 2, ID=5)</text>

    <line x1="590" y1="222" x2="330" y2="222" stroke="#9C27B0" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="460" y="218" text-anchor="middle" class="msg" fill="#9C27B0">PUBREC (ID=5)</text>

    <line x1="330" y1="248" x2="590" y2="248" stroke="#FF5722" stroke-width="1.5" marker-end="url(#arrowR)"/>
    <text x="460" y="244" text-anchor="middle" class="msg" fill="#FF5722">PUBREL (ID=5)</text>

    <line x1="590" y1="270" x2="330" y2="270" stroke="#4CAF50" stroke-width="1.5" marker-end="url(#arrowL)"/>
    <text x="460" y="266" text-anchor="middle" class="msg" fill="#4CAF50">PUBCOMP (ID=5)</text>
  </g>
</svg>